<root>
    <LISTAR_COMBO_PERFILES>
        <sql>
            SELECT per_id AS ID, perfil.per_nombre AS NOMBRE  FROM configuracionesnom.perfil WHERE perfil.per_estado ='A';         
        </sql>
    </LISTAR_COMBO_PERFILES>
    
    <CONSULTAR_USUARIO>
        <sql>
            SELECT USU_ID, USU_USUARIO AS USUARIO, USU_DOCUMENTO AS DOCUMENTO
            FROM USUARIO WHERE (USU_DOCUMENTO = ? OR USU_USUARIO =?);
        </sql>
    </CONSULTAR_USUARIO>
    
    <REGISTRAR_USUARIOS>
        <sql>
            INSERT INTO usuario(USU_DOCUMENTO,USU_PRIMER_NOMBRE,USU_SEGUNDO_NOMBRE,USU_PRIMER_APELLIDO,USU_SEGUNDO_APELLIDO,USU_USUARIO,PER_ID,USU_CONTRASENA,USU_USUARIO_CREACION) VALUES(?,?,?,?,?,?,?,?,?);       
        </sql>
    </REGISTRAR_USUARIOS>
    <VISUALIZAR_MENU>
        <sql>
            SELECT MEN_ID AS ID_MENU,MEN_NOMBRE AS NOMBRE_MENU, MEN_PADRE AS MENU_PADRE,CASE WHEN MEN_ESTADO = 'A' THEN 'ACTIVO' WHEN MEN_ESTADO ='I' THEN 'INACTIVO' END AS ESTADO FROM MENU WHERE MEN_PADRE IS NULL AND  MEN_ESTADO = 'A';
        </sql>
    </VISUALIZAR_MENU>
    <VISUALIZAR_USUARIOS>
        <sql>
            SELECT  USU_ID,USU_USUARIO_CREACION  AS CREACION ,USU_DOCUMENTO AS DOCUMENTO, 
            CONCAT(USU_PRIMER_NOMBRE,  ' ', COALESCE(USU_SEGUNDO_NOMBRE,''), ' ', USU_PRIMER_APELLIDO, ' ', COALESCE(USU_SEGUNDO_APELLIDO,'')) AS NOMBRES, USU_USUARIO AS USUARIO, UPPER(PER_NOMBRE) AS PERFIL,
            CASE WHEN USU_ESTADO = 'A' THEN 'ACTIVO' ELSE 'INACTIVO' END ESTADO,
            USU_PRIMER_NOMBRE AS PRIMER,USU_SEGUNDO_NOMBRE AS SEGUNDO,
            USU_PRIMER_APELLIDO AS PRIMER_API, USU_SEGUNDO_APELLIDO AS SEGUNDO_API,
            PER_ID FROM USUARIO INNER JOIN PERFIL USING(PER_ID) ORDER BY USU_ID DESC;

        </sql>
    </VISUALIZAR_USUARIOS>
    <CARGAR_PAGINAS_CODIGOS>
        <sql>
            SELECT 
            TIP_NOMBRE AS TIPO  ,
            CASE WHEN MEN.MEN_NOMBRE IS NULL THEN SUB.MEN_NOMBRE ELSE MEN.MEN_NOMBRE END AS MENU,
            COALESCE(CASE WHEN MEN.MEN_NOMBRE IS NULL THEN NULL ELSE  SUB.MEN_NOMBRE END,'')  AS SUB_MENU,
            PAC.SOF_NOMBRE AS PAGINA,PAC.PAG_ID AS PAG_ID,
            CASE WHEN MEN.MEN_ID IS NULL THEN  PER_P.MEN_ID ELSE MEN.MEN_ID END  AS ID_MENU,
            CASE WHEN MEN.MEN_ID IS NULL THEN NULL ELSE PER_P.MEN_ID END  AS SUB_MENUHIJO,PER_P.PRS_ESTADO AS ESTADO  
            FROM CONFIGURACIONESNOM.PAGINAS PAC 
            INNER JOIN CONFIGURACIONESNOM.PERFIL_PAGINAS PER_P USING(PAG_ID)
            INNER JOIN CONFIGURACIONESNOM.MENU SUB  ON SUB.MEN_ID = PER_P.MEN_ID 
            INNER JOIN CONFIGURACIONESNOM.TIPO_MENU  ON TIP_ID   =  TIP_MENU
            LEFT JOIN  CONFIGURACIONESNOM.MENU MEN   ON MEN.MEN_ID =  SUB.MEN_PADRE
            WHERE PER_ID = ?     ORDER BY 1 ,2
        </sql>
    </CARGAR_PAGINAS_CODIGOS>
    <CARGAR_PAGINAS_MENU>
        <sql>
            SELECT P.MEN_ID AS MEN_ID,P.SOF_NOMBRE AS NOMBRE,P.SOF_ESTADO AS ESTADO,P.PAG_ID AS PAG_ID FROM  CONFIGURACIONESNOM.MENU MENU INNER JOIN CONFIGURACIONESNOM.PAGINAS  P ON  MENU.MEN_ID =  P.MEN_ID
            WHERE MENU.MEN_ID =  ?  ORDER BY 2 ASC
        </sql>
    </CARGAR_PAGINAS_MENU>
    <REGISTRAR_PERFILES_MENU>
        <sql>
            INSERT INTO CONFIGURACIONESNOM.PERFIL_MENU (PER_ID,MEN_ID,MEN_PADRE,PRM_ESTADO) VALUES (?,?,?,'A');
        </sql>
    </REGISTRAR_PERFILES_MENU>
    <REGISTRAR_PERFIL_PAGINAS>
        <sql>
            INSERT INTO CONFIGURACIONESNOM.PERFIL_PAGINAS (PAG_ID,PER_ID,MEN_ID,PRS_ESTADO) VALUES(?,?,?,'A');
        </sql>
    </REGISTRAR_PERFIL_PAGINAS>
    <CONSULTAR_MENU_PADRE>
        <sql>
            SELECT PRM_ID FROM CONFIGURACIONESNOM.PERFIL_MENU  WHERE PER_ID = ? AND MEN_PADRE = ? ; 
        </sql>
    </CONSULTAR_MENU_PADRE>
    <CONSULTAR_MENU_HIJO>
        <sql>
            SELECT PRM_ID FROM CONFIGURACIONESNOM.PERFIL_MENU  WHERE PER_ID = ? AND MEN_ID = ?;
        </sql>
    </CONSULTAR_MENU_HIJO>
    <CONSULTAR_PAGINA_MENU>
        <sql>
            SELECT PER_ID FROM CONFIGURACIONESNOM.PERFIL_PAGINAS WHERE PER_ID = ? AND PAG_ID = ?;
        </sql>
    </CONSULTAR_PAGINA_MENU>
    <ELIMINAR_PERFIL_PAGINAS>
        <sql>
            DELETE FROM CONFIGURACIONESNOM.PERFIL_PAGINAS WHERE  PAG_ID = ? AND PER_ID = ?;
        </sql>
    </ELIMINAR_PERFIL_PAGINAS>
    <UPDATE_PERFIL_PAGINAS>
        <sql>
            UPDATE CONFIGURACIONESNOM.PERFIL_PAGINAS,(SELECT PRS_ESTADO AS ESTADO,PER_ID AS ID, PAG_ID AS ID_PAG  
            FROM CONFIGURACIONESNOM.PERFIL_PAGINAS  WHERE  PAG_ID = ? AND PER_ID = ?)AS TIPO 
            SET PRS_ESTADO = CASE WHEN TIPO.ESTADO ='A' THEN 'I' ELSE 'A' END 
            WHERE PER_ID = TIPO.ID AND PAG_ID = TIPO.ID_PAG ;
        </sql>
    </UPDATE_PERFIL_PAGINAS>
    <VISUALIZAR_SUBMENU>
        <sql>
            SELECT MEN_ID AS ID_MENU,MEN_NOMBRE AS NOMBRE_MENU, MEN_PADRE AS MENU_PADRE FROM MENU WHERE MEN_PADRE = ? AND  MEN_ESTADO = 'A' AND TIP_MENU = 1;
        </sql>
    </VISUALIZAR_SUBMENU>
    <CONSULTAR_PERFIL_PAGINAS_MENU>
        <sql>
            SELECT * FROM  CONFIGURACIONESNOM.MENU
            INNER JOIN CONFIGURACIONESNOM.PERFIL_PAGINAS PP ON PP.MEN_ID = MENU.MEN_ID
            WHERE PP.PER_ID = ? AND PP.MEN_ID = ? AND PP.PRS_ESTADO = 'A' 
            OR PP.PER_ID = ? AND  PP.MEN_ID = ? AND PP.PRS_ESTADO = 'A'

        </sql>
    </CONSULTAR_PERFIL_PAGINAS_MENU>
    <UPDATE_MENU_PERFIL_XMENU>
        <sql>
            UPDATE CONFIGURACIONESNOM.PERFIL_MENU PM ,(SELECT PER_ID,PRM_ESTADO AS ESTADO ,MEN_ID AS ID, MEN_PADRE AS MEN_PADRE FROM CONFIGURACIONESNOM.PERFIL_MENU  
            WHERE PER_ID = ? AND MEN_ID = ?  OR (PER_ID = ? AND MEN_PADRE = ?)) TIPO 
            SET PM.PRM_ESTADO = CASE WHEN PM.PRM_ESTADO = 'A' THEN 'I' ELSE 'A' END 
            WHERE PM.PER_ID = TIPO.PER_ID  AND PM.MEN_ID = TIPO.ID OR (PM.PER_ID = TIPO.PER_ID  AND PM.MEN_PADRE= TIPO.MEN_PADRE) ;
        </sql>
    </UPDATE_MENU_PERFIL_XMENU>
    <ACTUALIZAR_MENU_PADRE>
        <sql>
            UPDATE CONFIGURACIONESNOM.PERFIL_MENU ,(SELECT PM.MEN_PADRE AS PADRE, PM.PER_ID AS IDPERFIL, PM.MEN_ID AS MEN_ID,PM.PRM_ESTADO 
            FROM CONFIGURACIONESNOM.PERFIL_MENU PM 
            WHERE PM.PER_ID = ? AND PM.MEN_PADRE = ? ) PERFIL 
            SET PERFIL_MENU.PRM_ESTADO = CASE WHEN PERFIL.PRM_ESTADO ='A' THEN 'I' ELSE 'A' END 
            WHERE PERFIL_MENU.PER_ID = PERFIL.IDPERFIL  AND PERFIL_MENU.MEN_PADRE = PERFIL.PADRE;
        </sql>
    </ACTUALIZAR_MENU_PADRE>
    <SELECIONAR_CANTIDAD_PERFIL_MENU>
        <sql>
            SELECT COUNT(M.MEN_ID)AS CANTIDAD
            FROM  CONFIGURACIONESNOM.MENU AS M 
            INNER JOIN CONFIGURACIONESNOM.PERFIL_MENU PM ON PM.MEN_ID = M.MEN_ID
            WHERE PM.PER_ID = ? AND M.MEN_PADRE = ? AND PM.PRM_ESTADO='A'
        </sql>
    </SELECIONAR_CANTIDAD_PERFIL_MENU>
    <CONSULTAR_PERFIL_EXISTENCIA>
        <sql>
            SELECT PER_NOMBRE FROM CONFIGURACIONESNOM.PERFIL WHERE  PER_NOMBRE = ?;
        </sql>
    </CONSULTAR_PERFIL_EXISTENCIA>
    <REGISTRAR_PERFIL>
        <sql>
            INSERT INTO CONFIGURACIONESNOM.PERFIL(PER_NOMBRE ,PER_ESTADO)VALUES(?,?);
        </sql>
    </REGISTRAR_PERFIL>
    <CONSULTAR_PERFIL_EXISTENCIA_PAGINA>
        <sql>
            SELECT PERFIL.PER_ID,PERFIL_MENU.MEN_ID,PERFIL_MENU.MEN_PADRE 
            FROM  CONFIGURACIONESNOM.PERFIL_MENU
            INNER JOIN CONFIGURACIONESNOM.PERFIL ON PERFIL_MENU.PER_ID = PERFIL.PER_ID
            WHERE PERFIL.PER_ID = ? AND PERFIL.PER_ESTADO = 'A';
        </sql>
    </CONSULTAR_PERFIL_EXISTENCIA_PAGINA>
    <ELIMINAR_PERFIL>
        <sql>
            DELETE  FROM CONFIGURACIONESNOM.PERFIL WHERE PER_ID = ? ;
        </sql>
    </ELIMINAR_PERFIL>
    <ACTUALIZAR_PERFIL>
        <sql>
            UPDATE CONFIGURACIONESNOM.PERFIL
            SET PER_NOMBRE = ? 
            WHERE PER_ID = ? ;
        </sql>
    </ACTUALIZAR_PERFIL>
    <ELIMINAR_PERFIL_MENU>
        <sql>
            DELETE FROM CONFIGURACIONESNOM.PERFIL_MENU  WHERE PER_ID = ? AND MEN_ID = ? OR (PER_ID = ? AND MEN_PADRE = ?)
        </sql>
    </ELIMINAR_PERFIL_MENU>
  
    <GENERAR_MOVIEMIENTO_PERFIL>
        <sql>
            CALL administrador_perfiles(?,?,?,?,?);
        </sql>
    </GENERAR_MOVIEMIENTO_PERFIL>
    <ACTUALIZAR_USUARIO>
        <sql>
            UPDATE USUARIO 
            SET USU_DOCUMENTO  = ?,
            USU_PRIMER_NOMBRE = ?, 
            USU_SEGUNDO_NOMBRE =  ?,
            USU_PRIMER_APELLIDO = ?,
            USU_SEGUNDO_APELLIDO = ?,
            USU_USUARIO = ?,
            PER_ID = ?,
            USU_USUARIO_MOD = ?,
            USU_ESTADO=?,
            USU_FECHA_MOD = LOCALTIMESTAMP(0)
            WHERE USU_ID = ? 
        </sql>
    </ACTUALIZAR_USUARIO>
    <RESTABLECER_CONTRASENA>
        <sql>
            UPDATE USUARIO 
            SET usu_contrasena =?
            WHERE USU_ID = ? 
        </sql>
    </RESTABLECER_CONTRASENA>
    <PERMISOS_USUARIO>
        <sql>
            SELECT * FROM(
            SELECT  ope_id as id,ope_nombre as permiso, 'Desactivado' as estado, 'fa fa-toggle-off' as icono  FROM configuracionesnom.operaciones WHERE   ope_id  NOT IN(
            SELECT ope_id  FROM configuracionesnom.usuario_operaciones WHERE USU_ID = ?)
            UNION ALL 
            SELECT ope_id as id,ope_nombre, 'Activado' as estado,  'fa fa-toggle-on' as icono
            FROM configuracionesnom.operaciones ope  INNER JOIN configuracionesnom.usuario_operaciones 
            usu_op USING(ope_id) WHERE usu_op.usu_id =?
            )permisos order by estado desc  ;
        </sql>
    </PERMISOS_USUARIO>
    <AGREGAR_OPERACION_USUARIO>
        <sql>
            INSERT INTO USUARIO_OPERACIONES(OPE_ID,USU_ID)VALUES(?,?);
        </sql>
    </AGREGAR_OPERACION_USUARIO>
    <QUITAR_OPERACION_USUARIO>
        <sql>
            DELETE FROM  USUARIO_OPERACIONES WHERE  OPE_ID = ?  AND  USU_ID = ?;
        </sql>
    </QUITAR_OPERACION_USUARIO>
</root>
